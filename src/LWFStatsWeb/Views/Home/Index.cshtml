@model LWFStatsWeb.Models.HomeViewModels.IndexViewModel

@{
    ViewBag.Title = "";
    ViewBag.MetaDescription = "Statistics of clans in Farm War Alliance (FWA), Clash of Clans";
}

<ol class="breadcrumb">
    <li class="active">Home</li>
</ol>

<div class="jumbotron header-jumbo">
    <h1>💎 FWA Stats</h1>
    <p>
        Statistics about FWA clans and wars.
    </p>
</div>

<div class="row">
    @foreach (var stats in Model.LastSyncs)
    {
        <div class="col-sm-6">
            <h3>Current war <small>@stats.Status</small></h3>
            <div id="piechart" style="width:300px;height:200px"><p><span class="glyphicon glyphicon-hourglass"></span> Loading...</p></div>
            <div style="margin-top:10px;"><a asp-area="" asp-controller="Syncs" asp-action="Details" asp-route-id="@stats.Name" class="btn btn-default">More details</a></div>
        </div>
    }
    @foreach (var history in Model.SyncHistories)
    {
        <div class="col-sm-6">
            <h3>Last @history.Syncs.Count wars</h3>
            <div id="areachart" style="width:300px;height:200px"><p><span class="glyphicon glyphicon-hourglass"></span> Loading...</p></div>
            <div style="margin-top:10px;"><a asp-area="" asp-controller="Syncs" asp-action="Index" class="btn btn-default">More details</a></div>
        </div>
    }
    @if (Model.TownhallCounters != null && Model.TownhallCounters.Count > 0)
    {
        <div class="col-sm-6">
            <h3>TH composition</h3>
            <div id="thchart" style="width:300px;height:200px"><p><span class="glyphicon glyphicon-hourglass"></span> Loading...</p></div>
            <div style="margin-top:10px;"><a href="https://docs.google.com/spreadsheets/d/1QPyciESc0AifmKgUDV5bua0LDI_hUqSRHXi6_TwCtLM/edit#gid=587579726" class="btn btn-default">More details</a></div>
        </div>
    }
    @foreach (var counters in Model.Counters)
    {
        <div class="col-sm-6">
            <h3>Key numbers</h3>
            <table>
                <tr>
                    <td style="padding:5px;"><b>@counters.ClanCount</b></td>
                    <td style="padding:5px;">clans</td>
                </tr>
                <tr>
                    <td style="padding:5px;"><b>@counters.MemberCount</b></td>
                    <td style="padding:5px;">members</td>
                </tr>
                <tr>
                    <td style="padding:5px;"><b>@counters.WinPercentage%</b></td>
                    <td style="padding:5px;">win ratio</td>
                </tr>
                <tr>
                    <td style="padding:5px;"><b>@counters.MatchPercentage%</b></td>
                    <td style="padding:5px;">match ratio</td>
                </tr>
            </table>
            <p style="margin-top:20px;"><a asp-area="" asp-controller="Clans" asp-action="Index" class="btn btn-default">View all clans</a></p>
        </div>
    }
</div>

@section scripts {

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(function() {

            @foreach (var group in Model.LastSyncs)
            {
                var data = "piedata";
                var options = "pieoptions";
                var chart = "piechart";
                <text>
                var @data = google.visualization.arrayToDataTable([
                    ['Wars', 'Count'],
                    ['Matches', @group.AllianceMatches],
                    ['Mismatches', @group.WarMatches],
                    ['Didn\'t start', @group.NotStarted]
                ]);

                var @options = {
                    pieHole: 0.4,
                    chartArea: { left: 15, top: 15, width: '270', height: '170' }
                };

                new google.visualization.PieChart(document.getElementById('@chart')).draw(@data, @options);
                </text>
            }
            @foreach(var history in Model.SyncHistories)
            {
                var data = "areadata";
                var options = "areaoptions";
                var chart = "areachart";
                <text>
                var @data = google.visualization.arrayToDataTable([
                    ['Date', 'Matches', 'Mismatches', 'Didn\'t start']
                </text>
                @foreach(var sync in history.Syncs)
                {
                    @: ,['@sync.Name', @sync.AllianceMatches, @sync.WarMatches, @sync.NotStarted]
                }
                <text>
                ]);

                var @options = {
                    isStacked: 'relative',
                    legend: {position: 'top', maxLines: 3},
                    vAxis: {format: 'percent' },
                    chartArea: { left: 35, top: 15, width: '250', height: '170' }
                };

                new google.visualization.AreaChart(document.getElementById('@chart')).draw(@data, @options);
                </text>
            }
            @if(Model.TownhallCounters != null && Model.TownhallCounters.Count > 0)
            {
                var data = "thdata";
                var options = "thoptions";
                var chart = "thchart";
                <text>
                var @data = google.visualization.arrayToDataTable([
                    ['Weight', 'TH11', 'TH10', 'TH9', 'TH8']
                </text>
                @foreach(var th in Model.TownhallCounters)
                {
                    @: ,[@th.Weight.ToString().Replace(",","."), @th.TH11.ToString().Replace(",","."), @th.TH10.ToString().Replace(",", "."), @th.TH9.ToString().Replace(",", "."), @th.TH8.ToString().Replace(",", ".")]
                }
                <text>
                ]);

                var @options = {
                    isStacked: 'absolute',
                    legend: {position: 'top', maxLines: 3},
                    chartArea: { left: 35, top: 15, width: '250', height: '170' }
                };

                new google.visualization.AreaChart(document.getElementById('@chart')).draw(@data, @options);
                </text>
            }

        });

    </script>
}